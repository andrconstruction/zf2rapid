# ZF2rapid tutorial

In this tutorial you will learn how to create an application step by step with
ZF2rapid.

 * [Create new project](tutorial-create-project.md)
 * [Create new module](tutorial-create-module.md)
 * [Create controllers and actions](tutorial-create-controllers-actions.md)
 * [Create routing and generate maps](tutorial-create-routing-maps.md)
 * [Create controller plugin and view helper](tutorial-create-controller-plugin-view-helper.md)
 * [Create model classes](tutorial-crud-create-model.md)
 * [Create application](tutorial-crud-application.md)

## PLEASE READ CAREFULLY

The CRUD commands of ZF2rapid do not have the goal to create a full-featured
object-relational-mapper (ORM) for you. If you need such a tool please refer to 
[Doctrine](http://www.doctrine-project.org/), [Propel](http://propelorm.org/), 
[ReadBeanPHP](http://www.redbeanphp.com/) etc.

The classes generated by the CRUD commands try to consider the best practices of 
implementing a simple model layer with the Zend Framework 2. The entities represent 
your data as objects, the table gateways allow the access to database tables and 
the hydrators help to convert the data passed from the database to your 
entities. The generated repositories are meant to be used within your 
controllers or other classes which access to the data.

You can extend the generated classes and add more logic to it. But please 
note, that your amendments will be lost when you try to rebuild the classes 
after you made changes to your database structure. 

The generated classes should only be used for rapid prototyping or as a base for your
own implementations!
 
Currently the CRUD commands are only tested for a MySQL database!

## Create model classes

To create model classes for an existing database table, you need to setup a 
database first. Please create a MySQL database `zf2rapid-tutorial` first and 
grant the needed privileges to a user `zf2rapid` with the password `zf2rapid`.
To proceed this tutorial you can easily use the 
[MySQL database dump](tutorial-crud-database-structure.md)
to create a database structure. 

Afterwards you need to setup the database connection in your current project. 
This should be done in the file `/config/autoload/development.php`, for example. 
Please enter your database configuration.

    return array(
        'db' => array(
            'driver'  => 'pdo',
            'dsn'     => 'mysql:dbname=zf2rapid-tutorial;host=localhost;charset=utf8',
            'user'    => 'zf2rapid',
            'pass'    => 'zf2rapid',
        ),
        [...]
    );

To use the CRUD commands you need to setup the database connection in the 
project you want to create the classes and views in. This should be done in the 
file `/config/autoload/development.php`, for example. Please enter your own 
database configuration.

    return array(
        'db' => array(
            'driver'  => 'pdo',
            'dsn'     => 'mysql:dbname=DATEBASE;host=localhost;charset=utf8',
            'user'    => 'USER',
            'pass'    => 'PASS',
        ),
        [...]
    );

Now you can check if your database configuration is correct and if you can 
access your database.
 
    $ zf2rapid crud-check-db

If you get the message `The connection to the database was successful.` you 
show a list of all tables which are accessible for this database 
configuration. 

    $ zf2rapid crud-show-tables

Ww want to create a new `CustomerDomain` module first. All classes and files from the 
CRUD create model command will be placed within this module. Later on we will create other 
modules to create the application in. So we will seperate the model from the application
(controller and view) to ease the reusability of our model classes. If you don't like the term 
`CustomerDomain` you can user a different name like `CustomerModel`. In the following we will 
stick to `CustomerDomain`.
  
    $ zf2rapid create-module CustomerDomain

Now you are ready to create all model classes for the tables within the new 
`CustomerDomain` module . We will start with the `customer` table.
 
    $ zf2rapid crud-create-model CustomerDomain customer

Oops. You should get the error message `Due to a foreign key constraint you 
need to process table country from database zf2rapid-example as well.`. The 
table `customer` is connected to the table `country` with a foreign key 
constraint. To fully create the model classes for the `customer` table you also 
need to specify the `country` table as well.

    $ zf2rapid crud-create-model CustomerDomain customer,country

The following tasks are executed when creating new model classes:

 * Load tables from database
 * Create directory structure for model classes
 * Create entity class(es)
 * (optional) Create hydrator strategy class(es)
 * Create hydrator class(es)
 * Create hydrator factory(ies)
 * Create table gateway class(es)
 * Create table gateway factory(ies)
 * Create repository class(es)
 * Create repository factory(ies)
 * Writing model configuration for module

## Structure of module `CustomerDomain` after model creation

The generated structure of the `CustomerDomain` module should look like this:

    --- module
      +--- Application
      +--- CustomerDomain
         +--- config
         |  +--- module.config.php
         +--- src
         |  +--- CustomerDomain
         |       +--- Model                                    <---- new directory
         |           +--- Entity                               <---- new directory
         |           |  +--- CountryEntity.php                 <---- new file
         |           |  +--- CustomerEntity.php                <---- new file
         |           +--- Hydrator                             <---- new directory
         |           |  +--- Strategy                          <---- new directory
         |           |     +--- CountryStrategy.php            <---- new file
         |           |  +--- CountryHydrator.php               <---- new file
         |           |  +--- CountryHydratorFactory.php        <---- new file
         |           |  +--- CustomerHydrator.php              <---- new file
         |           |  +--- CustomerHydratorFactory.php       <---- new file
         |           +--- Repository                           <---- new directory
         |           |  +--- CountryRepository.php             <---- new file
         |           |  +--- CountryRepositoryFactory.php      <---- new file
         |           |  +--- CustomerRepository.php            <---- new file
         |           |  +--- CustomerRepositoryFactory.php     <---- new file
         |           +--- TableGateway                         <---- new directory
         |              +--- CountryTableGateway.php           <---- new file
         |              +--- CountryTableGatewayFactory.php    <---- new file
         |              +--- CustomerTableGateway.php          <---- new file
         |              +--- CustomerTableGatewayFactory.php   <---- new file
         +--- view
         |  +--- customer-domain
         +--- autoload_classmap.php
         +--- Module.php
         +--- template_map.php
      +--- Shop
         
To the `/module/CustomerDomain/config/module.config.php` file the configuration for the 
model classes should be added. 

    <?php
    /**
     * ZF2rapid Tutorial
     *
     * @copyright (c) 2015 John Doe
     * @license All rights reserved
     */
    
    return array(
        [...]
        'hydrators' => array(
            'factories' => array(
                'CustomerDomain\\Db\\Customer' => 'CustomerDomain\\Model\\Hydrator\\CustomerHydratorFactory',
                'CustomerDomain\\Db\\Country' => 'CustomerDomain\\Model\\Hydrator\\CountryHydratorFactory',
            ),
        ),
        'service_manager' => array(
            'factories' => array(
                'CustomerDomain\\Model\\TableGateway\\Customer' => 'CustomerDomain\\Model\\TableGateway\\CustomerTableGatewayFactory',
                'CustomerDomain\\Model\\Repository\\Customer' => 'CustomerDomain\\Model\\Repository\\CustomerRepositoryFactory',
                'CustomerDomain\\Model\\TableGateway\\Country' => 'CustomerDomain\\Model\\TableGateway\\CountryTableGatewayFactory',
                'CustomerDomain\\Model\\Repository\\Country' => 'CustomerDomain\\Model\\Repository\\CountryRepositoryFactory',
            ),
        ),
    );

## Generated entity classes

The `/module/CustomerDomain/src/CustomerDomain/Model/Entity/CountryEntity.php` file contains 
the `CountryEntity` class, which consists of the properties `code` and `name` 
from the database table `country` and the corresponding setter and getter 
methods. The following listing is reduced to the essential. 

    <?php
    /**
     * ZF2 Application built by ZF2rapid
     *
     * @copyright (c) 2015 John Doe
     * @license http://opensource.org/licenses/MIT The MIT License (MIT)
     */
    namespace CustomerDomain\Model\Entity;
    
    use ZF2rapidDomain\Entity\AbstractEntity;
    
    /**
     * CountryEntity
     *
     * Provides the CountryEntity entity for the CustomerDomain Module
     *
     * @package CustomerDomain\Model\Entity
     */
    class CountryEntity extends AbstractEntity
    {
        protected $code = null;
        protected $name = null;
    
        public function getIdentifier() {}
    
        protected function setCode($code) {}
    
        public function getCode() {}
    
        protected function setName($name) {}
    
        public function getName() {}
    }

The `/module/CustomerDomain/src/CustomerDomain/Model/Entity/CustomerEntity.php` file 
contains the `CustomerEntity` class, which consists all the properties from the 
database table `customer` and the corresponding setter and getter methods. The 
following listing is reduced to the essential. Please note that columns with 
underscores have be camelCased and that the `setCountry()` method has a type hint
for the `CountryEntity`.

    <?php
    /**
     * ZF2 Application built by ZF2rapid
     *
     * @copyright (c) 2015 John Doe
     * @license http://opensource.org/licenses/MIT The MIT License (MIT)
     */
    namespace CustomerDomain\Model\Entity;
    
    use ZF2rapidDomain\Entity\AbstractEntity;
    
    /**
     * CustomerDomainEntity
     *
     * Provides the CustomerEntity entity for the CustomerDomain Module
     *
     * @package CustomerDomain\Model\Entity
     */
    class CustomerEntity extends AbstractEntity
    {
        protected $id = null;
        protected $created = null;
        protected $changed = null;
        protected $status = null;
        protected $firstName = null;
        protected $lastName = null;
        protected $street = null;
        protected $zip = null;
        protected $city = null;
        protected $country = null;
    
        public function getIdentifier() {}
    
        protected function setId($id) {}
    
        public function getId() {}
    
        protected function setCreated($created) {}
    
        public function getCreated() {}
    
        protected function setChanged($changed) {}
    
        public function getChanged() {}
    
        protected function setStatus($status) {}
    
        public function getStatus() {}
    
        protected function setFirstName($firstName) {}
    
        public function getFirstName() {}
    
        protected function setLastName($lastName) {}
    
        public function getLastName() {}
    
        protected function setStreet($street) {}
    
        public function getStreet() {}
    
        protected function setZip($zip) {}
    
        public function getZip() {}
    
        protected function setCity($city) {}
    
        public function getCity() {}
    
        protected function setCountry(CountryEntity $country) {}
    
        public function getCountry() {}
    }

Both entity classes extends the `AbstractEntity` class from the 
[ZF2rapidDomain](https://github.com/ZFrapid/zf2rapid-domain) module which was 
installed with the SkeletonApplication in the first step. The `AbstractEntity` 
class implements the methods `exchangeArray()` and `getArrayCopy()` which
work together with the generated hydrators. The `AbstractEntity` also provides the
`getIdentifier()` method to get the unique identifier for an entity.

## Generated hydrator classes, strategies and factories

The `/module/CustomerDomain/src/CustomerDomain/Model/Hydrator/CountryHydrator.php` file contains 
the `CountryHydrator` class, which extends the `ArraySerializable` hydrator. The following 
listing is reduced to the essential. 

    <?php
    /**
     * ZF2 Application built by ZF2rapid
     *
     * @copyright (c) 2015 John Doe
     * @license http://opensource.org/licenses/MIT The MIT License (MIT)
     */
    namespace CustomerDomain\Model\Hydrator;
    
    use Zend\Stdlib\Hydrator\ArraySerializable;
    
    /**
     * CountryHydrator
     *
     * Provides the CountryHydrator hydrator for the CustomerDomain Module
     *
     * @package CustomerDomain\Model\Hydrator
     */
    class CountryHydrator extends ArraySerializable
    {
        public function extract($object) {}
    
        public function hydrate(array $data, $object) {}
    }

The corresponding hydrator factory should be found in the 
`/module/CustomerDomain/src/CustomerDomain/Model/Hydrator/CountryHydratorFactory.php` file and 
contains an ready-to-use factory for your `CountryHydrator` if you need to inject 
more dependencies later on. 

The `CustomerHydrator` in the file `/module/CustomerDomain/src/CustomerDomain/Model/Hydrator/CustomerHydrator.php`
looks quite similar to the `CountryHydrator` shown above. 

In the file `/module/CustomerDomain/src/CustomerDomain/Model/Hydrator/CustomerHydratorFactory.php` you 
should find the corresponding `CustomerHydratorFactory`. Please note the addition of a 
hydrator strategy for the `country` column. 

    <?php
    /**
     * ZF2 Application built by ZF2rapid
     *
     * @copyright (c) 2015 John Doe
     * @license http://opensource.org/licenses/MIT The MIT License (MIT)
     */
    namespace CustomerDomain\Model\Hydrator;
    
    use Zend\ServiceManager\FactoryInterface;
    use Zend\ServiceManager\ServiceLocatorAwareInterface;
    use Zend\ServiceManager\ServiceLocatorInterface;
    use CustomerDomain\Model\Hydrator\Strategy\CountryStrategy;
    
    /**
     * CustomerHydratorFactory
     *
     * Creates an instance of CustomerHydrator
     *
     * @package CustomerDomain\Model\Hydrator
     */
    class CustomerHydratorFactory implements FactoryInterface
    {
    
        /**
         * Create service
         *
         * @param ServiceLocatorInterface $hydratorManager
         * @return CustomerHydrator
         */
        public function createService(ServiceLocatorInterface $hydratorManager)
        {
            /** @var ServiceLocatorAwareInterface $hydratorManager */
            $serviceLocator = $hydratorManager->getServiceLocator();
    
            $instance = new CustomerHydrator();
            $instance->addStrategy('country', new CountryStrategy());
    
            return $instance;
        }
    }
    
The `CountryStrategy` class in the 
`/module/CustomerDomain/src/CustomerDomain/Model/Hydrator/Strategy/CountryStrategey.php` file was generated
to handle the foreign key constraint for the `country` column in the `customer` table. It helps 
to convert the data read from the database into an `CountryEntity` and extract the relevant
data from the `CountryEntity` to prepare the writing to the database.
 
    <?php
    /**
     * ZF2 Application built by ZF2rapid
     *
     * @copyright (c) 2015 John Doe
     * @license http://opensource.org/licenses/MIT The MIT License (MIT)
     */
    namespace CustomerDomain\Model\Hydrator\Strategy;
    
    use Zend\Stdlib\Hydrator\Strategy\StrategyInterface;
    use CustomerDomain\Model\Entity\CountryEntity;
    
    /**
     * CountryStrategy
     *
     * Provides the Country hydrator strategy for the CustomerDomain Module
     *
     * @package CustomerDomain\Model\Hydrator\Strategy
     */
    class CountryStrategy implements StrategyInterface
    {
    
        /**
         * Extract identifier from entity
         *
         * @param CountryEntity $value
         * @return string
         */
        public function extract($value)
        {
            return $value->getIdentifier();
        }
    
        /**
         * Hydrate an entity by populating data
         *
         * @param $value
         * @param array $data
         * @return CountryEntity
         */
        public function hydrate($value, array $data = array())
        {
            $country = new CountryEntity();
            $country->exchangeArray(
                array(
                    'code' => $data['country.code'],
                    'name' => $data['country.name'],
                )
            );
    
            return $country;
        }
    }

The generated hydrator classes, factories and strategies are prepared to work smoothly with
the generated table gateway classes.

## Generated table gateway classes and factories

The `/module/CustomerDomain/src/CustomerDomain/Model/TableGateway/CountryTableGateway.php` file contains 
the `CountryTableGateway` class, which extends the `AbstractTableGateway` class from the 
[ZF2rapidDomain](https://github.com/ZFrapid/zf2rapid-domain) module. The corresponding 
`CountryTableGatewayFactory` injects the database adapter and a `HydratingResultSet` instance
with combines the `CountryEntity` and the `CountryHydrator`. 

More interesting is the `CustomerTableGateway` class from the 
`/module/CustomerDomain/src/CustomerDomain/Model/TableGateway/CustomerTableGateway.php` file which also 
extends the `AbstractTableGateway` class from the `ZF2rapidDomain` module. Please
note the `selectWith()` method which adds a join to the `country` table to combine the 
customer data with the country data. This joined data will be used by the `CountryStrategy` 
to convert it into an `CountryEntity` instance.

    <?php
    /**
     * ZF2 Application built by ZF2rapid
     *
     * @copyright (c) 2015 John Doe
     * @license http://opensource.org/licenses/MIT The MIT License (MIT)
     */
    namespace CustomerDomain\Model\TableGateway;
    
    use ZF2rapidDomain\TableGateway\AbstractTableGateway;
    use Zend\Db\ResultSet\ResultSetInterface;
    use Zend\Db\Sql\Select;
    
    /**
     * CustomerTableGateway
     *
     * Provides the CustomerTableGateway table gateway for the CustomerDomain Module
     *
     * @package CustomerDomain\Model\TableGateway
     */
    class CustomerTableGateway extends AbstractTableGateway
    {
        /**
         * Add join tables
         *
         * @param Select $select
         * @return ResultSetInterface
         */
        public function selectWith(Select $select)
        {
            $select->join(
                'country',
                'customer.country = country.code',
                array(
                    'country.code' => 'code',
                    'country.name' => 'name',
                )
            );
    
            return parent::selectWith($select);
        }
    }

The corresponding factory for `CustomerTableGateway` class can be found in the 
`/module/CustomerDomain/src/CustomerDomain/Model/TableGateway/CustomerTableGatewayFactory.php` file.
This factory configures the `CustomerTableGateway` instance and injects the database adapter 
and the needed `HydratingResultSet`.

    <?php
    /**
     * ZF2 Application built by ZF2rapid
     *
     * @copyright (c) 2015 John Doe
     * @license http://opensource.org/licenses/MIT The MIT License (MIT)
     */
    namespace CustomerDomain\Model\TableGateway;
    
    use CustomerDomain\Model\Entity\CustomerEntity;
    use CustomerDomain\Model\Hydrator\CustomerHydrator;
    use Zend\Db\Adapter\AdapterInterface;
    use Zend\Db\ResultSet\HydratingResultSet;
    use Zend\ServiceManager\FactoryInterface;
    use Zend\ServiceManager\ServiceLocatorInterface;
    use Zend\Stdlib\Hydrator\HydratorPluginManager;
    
    /**
     * CustomerTableGatewayFactory
     *
     * Creates an instance of CustomerTableGateway
     *
     * @package CustomerDomain\Model\TableGateway
     */
    class CustomerTableGatewayFactory implements FactoryInterface
    {
        /**
         * Create service
         *
         * @param ServiceLocatorInterface $serviceLocator
         * @return CustomerTableGateway
         */
        public function createService(ServiceLocatorInterface $serviceLocator)
        {
            /** @var HydratorPluginManager $hydratorManager */
            $hydratorManager = $serviceLocator->get('HydratorManager');
    
            /** @var AdapterInterface $dbAdapter */
            $dbAdapter = $serviceLocator->get('Zend\Db\Adapter\Adapter');
    
            /** @var CustomerHydrator $hydrator */
            $hydrator  = $hydratorManager->get('CustomerDomain\Db\Customer');
            $entity    = new CustomerEntity();
            $resultSet = new HydratingResultSet($hydrator, $entity);
    
            $instance = new CustomerTableGateway(
                'customer', $dbAdapter, null, $resultSet
            );
    
            return $instance;
        }
    }

The table gateway classes will be used by the generated repository classes and ease
the persistence of your data. They should not be used directly, but only in combination
with the repositories.

## Generated repository classes and factories

The `/module/CustomerDomain/src/CustomerDomain/Model/Repository/CountryRepository.php` file contains 
the `CountryRepository` class, which extends the `AbstractRepository` class from the 
[ZF2rapidDomain](https://github.com/ZFrapid/zf2rapid-domain) module. The corresponding 
`CountryRepositoryFactory` injects the `CountryTableGateway` instance. 

In the file `/module/CustomerDomain/src/CustomerDomain/Model/Repository/CustomerRepository.php` you
will find the `CustomerRepository` class which also extends the `AbstractRepository` class 
from the `ZF2rapidDomain` module. The `AbstractRepository` class provides a couple of methods
for reading and persisting entities by using the `CustomerTableGateway` instance.

    <?php
    /**
     * ZF2 Application built by ZF2rapid
     *
     * @copyright (c) 2015 John Doe
     * @license http://opensource.org/licenses/MIT The MIT License (MIT)
     */
    namespace CustomerDomain\Model\Repository;
    
    use ZF2rapidDomain\Repository\AbstractRepository;
    
    /**
     * CustomerRepository
     *
     * Provides the CustomerRepository repository for the Customer Module
     *
     * @package CustomerDomain\Model\Repository
     */
    class CustomerRepository extends AbstractRepository
    {
    }

The repository factory `CustomerRepositoryFactory` is almost self-explanatory.

    <?php
    /**
     * ZF2 Application built by ZF2rapid
     *
     * @copyright (c) 2015 John Doe
     * @license http://opensource.org/licenses/MIT The MIT License (MIT)
     */
    namespace CustomerDomain\Model\Repository;
    
    use CustomerDomain\Model\TableGateway\CustomerTableGateway;
    use Zend\ServiceManager\FactoryInterface;
    use Zend\ServiceManager\ServiceLocatorInterface;
    
    /**
     * CustomerRepositoryFactory
     *
     * Creates an instance of CustomerRepository
     *
     * @package CustomerDomain\Model\Repository
     */
    class CustomerRepositoryFactory implements FactoryInterface
    {
        /**
         * Create service
         *
         * @param ServiceLocatorInterface $serviceLocator
         * @return CustomerRepository
         */
        public function createService(ServiceLocatorInterface $serviceLocator)
        {
            /** @var CustomerTableGateway $tableGateway */
            $tableGateway = $serviceLocator->get('CustomerDomain\Model\TableGateway\Customer');
    
            $instance = new CustomerRepository($tableGateway);
    
            return $instance;
        }
    }

The repository classes should be used within your controllers as a gateway to the database. 
You should never access the table gateway instances directly. The repositories can also be used 
within a view helper to read some data (but never ever to persist data).

**Please note:** You can easily extend all the generated classes but you must be aware that you
currently cannot rerun the class generation without the loss of your extensions. A better solution
would be that you do not extend the classes themselves but create new classes which extend the 
generated classes. 

[Continue to create application](tutorial-crud-application.md)
